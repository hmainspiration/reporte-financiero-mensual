<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Ministerial Digital</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) para generar hojas de cálculo -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos personalizados y mejoras de diseño */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .accordion-header.active .chevron-icon {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
            padding: 0 1.25rem;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-600 mb-1;
        }
        .form-input {
            @apply block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-300;
        }
        .grid-cols-form {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .photo-placeholder {
            @apply w-36 h-44 bg-gray-100 rounded-lg flex flex-col items-center justify-center text-gray-500 border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-200 hover:border-indigo-400 transition-all duration-300;
        }
        .photo-placeholder i {
            @apply text-4xl mb-2 text-gray-400;
        }
        .photo-preview {
            @apply w-36 h-44 rounded-lg object-cover shadow-md;
        }
        /* Estilo para notificaciones */
        #notification-area {
            @apply fixed top-5 right-5 z-50;
        }
        .toast {
            @apply bg-white rounded-lg shadow-lg p-4 flex items-center border-l-4;
            animation: fadeInOut 4s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="notification-area"></div>

    <div id="app-container" class="max-w-5xl mx-auto">
        <header class="text-center mb-8 p-6 bg-white rounded-lg shadow-md border border-gray-200/80">
            <h1 class="text-3xl font-bold text-blue-800 uppercase">Ficha Ministerial Digital</h1>
            <p class="text-md text-gray-600 mt-1">Información Ministerial - Edición 2025</p>
        </header>

        <form id="formulario-exportar">
            
            <!-- 1. Sección de Información del Ministro -->
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>1. Información del Ministro</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 py-5">
                        <div class="flex flex-col items-center lg:items-start">
                            <label class="form-label">Foto</label>
                            <div id="ministro-photo-placeholder" class="photo-placeholder" onclick="document.getElementById('ministro-photo-input').click()">
                                <i class="fa-solid fa-camera-retro"></i>
                                <span>Subir Foto</span>
                            </div>
                            <img id="ministro-photo-preview" class="photo-preview hidden" alt="Foto del Ministro"/>
                            <input type="file" id="ministro-photo-input" class="hidden" accept="image/*" onchange="previewImage(event, 'ministro-photo-preview', 'ministro-photo-placeholder')">
                        </div>
                        <div class="grid grid-cols-form gap-6 col-span-1 lg:col-span-3">
                            <div><label class="form-label">Nombre Completo (Según la cédula)</label><input type="text" id="ministro-nombre-completo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Nacimiento</label><input type="date" id="ministro-f-nacimiento" class="form-input"></div>
                            <div><label class="form-label">Ciudad</label><input type="text" id="ministro-ciudad" class="form-input"></div>
                            <div><label class="form-label">Departamento</label><input type="text" id="ministro-depto" class="form-input"></div>
                            <div><label class="form-label">País</label><input type="text" id="ministro-pais" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo</label><input type="date" id="ministro-f-bautismo" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Bautismo)</label><input type="text" id="ministro-iglesia-bautismo" class="form-input"></div>
                            <div><label class="form-label">Quien Bautizó</label><input type="text" id="ministro-quien-bautizo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo Espiritual</label><input type="date" id="ministro-f-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Espiritual)</label><input type="text" id="ministro-iglesia-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Quien Testificó</label><input type="text" id="ministro-quien-testifico" class="form-input"></div>
                            <div><label class="form-label">¿Se casó por la Iglesia?</label><select id="ministro-casado-iglesia" class="form-input"><option>Sí</option><option>No</option><option>Unión Libre</option></select></div>
                            <div><label class="form-label">Fecha de Matrimonio</label><input type="date" id="ministro-f-matrimonio" class="form-input"></div>
                            <div><label class="form-label">Quien los Casó</label><input type="text" id="ministro-quien-caso" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Matrimonio)</label><input type="text" id="ministro-iglesia-matrimonio" class="form-input"></div>
                            <div><label class="form-label">Fecha que Salió a la Obra</label><input type="date" id="ministro-f-salida-obra" class="form-input"></div>
                            <div><label class="form-label">Salió Soltero o Casado</label><select id="ministro-estado-salida" class="form-input"><option>Soltero</option><option>Casado</option></select></div>
                            <div><label class="form-label">Lugar donde salió</label><input type="text" id="ministro-lugar-salida" class="form-input"></div>
                            <div><label class="form-label">Ministro que lo recomendó</label><input type="text" id="ministro-quien-recomendo" class="form-input"></div>
                            <div><label class="form-label">Nivel Académico</label><input type="text" id="ministro-nivel-academico" class="form-input"></div>
                            <div><label class="form-label">Conocimiento de Oficio</label><input type="text" id="ministro-oficio" class="form-input"></div>
                            <div><label class="form-label">Nombre del Padre</label><input type="text" id="ministro-padre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Padre)</label><select id="ministro-padre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Padre)</label><select id="ministro-padre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Nombre de la Madre</label><input type="text" id="ministro-madre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Madre)</label><select id="ministro-madre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Madre)</label><select id="ministro-madre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Posee Visa</label><select id="ministro-visa" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Visa)</label><input type="date" id="ministro-visa-vigencia" class="form-input"></div>
                            <div><label class="form-label">Posee Residencia</label><select id="ministro-residencia" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Residencia)</label><input type="date" id="ministro-residencia-vigencia" class="form-input"></div>
                            <div><label class="form-label">Enfermedad</label><select id="ministro-enfermedad" class="form-input"><option>No</option><option>Sí</option></select></div>
                            <div><label class="form-label">Tipo de Enfermedad</label><input type="text" id="ministro-enfermedad-tipo" class="form-input"></div>
                            <div><label class="form-label">Desde Cuando</label><input type="date" id="ministro-enfermedad-desde" class="form-input"></div>
                            <div><label class="form-label">¿Está en Tratamiento?</label><select id="ministro-enfermedad-tratamiento" class="form-input"><option>Sí</option><option>No</option></select></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Sección de Información de la Esposa -->
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                 <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>2. Información de la Esposa</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 py-5">
                        <div class="flex flex-col items-center lg:items-start">
                            <label class="form-label">Foto</label>
                            <div id="esposa-photo-placeholder" class="photo-placeholder" onclick="document.getElementById('esposa-photo-input').click()">
                                <i class="fa-solid fa-camera-retro"></i>
                                <span>Subir Foto</span>
                            </div>
                            <img id="esposa-photo-preview" class="photo-preview hidden" alt="Foto de la Esposa"/>
                            <input type="file" id="esposa-photo-input" class="hidden" accept="image/*" onchange="previewImage(event, 'esposa-photo-preview', 'esposa-photo-placeholder')">
                        </div>
                        <div class="grid grid-cols-form gap-6 col-span-1 lg:col-span-3">
                           <!-- IDs añadidos para la esposa -->
                            <div><label class="form-label">Nombre Completo (Según la cédula)</label><input type="text" id="esposa-nombre-completo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Nacimiento</label><input type="date" id="esposa-f-nacimiento" class="form-input"></div>
                            <div><label class="form-label">Ciudad</label><input type="text" id="esposa-ciudad" class="form-input"></div>
                            <div><label class="form-label">Departamento</label><input type="text" id="esposa-depto" class="form-input"></div>
                            <div><label class="form-label">País</label><input type="text" id="esposa-pais" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo</label><input type="date" id="esposa-f-bautismo" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Bautismo)</label><input type="text" id="esposa-iglesia-bautismo" class="form-input"></div>
                            <div><label class="form-label">Quien Bautizó</label><input type="text" id="esposa-quien-bautizo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo Espiritual</label><input type="date" id="esposa-f-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Espiritual)</label><input type="text" id="esposa-iglesia-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Quien Testificó</label><input type="text" id="esposa-quien-testifico" class="form-input"></div>
                            <div><label class="form-label">Fecha que Salió a la Obra</label><input type="date" id="esposa-f-salida-obra" class="form-input"></div>
                            <div><label class="form-label">Salió Soltera o Casada</label><select id="esposa-estado-salida" class="form-input"><option>Soltera</option><option>Casada</option></select></div>
                            <div><label class="form-label">Lugar donde salió</label><input type="text" id="esposa-lugar-salida" class="form-input"></div>
                            <div><label class="form-label">Ministro que la recomendó</label><input type="text" id="esposa-quien-recomendo" class="form-input"></div>
                            <div><label class="form-label">Nivel Académico</label><input type="text" id="esposa-nivel-academico" class="form-input"></div>
                            <div><label class="form-label">Conocimiento de Oficio</label><input type="text" id="esposa-oficio" class="form-input"></div>
                            <div><label class="form-label">Nombre del Padre</label><input type="text" id="esposa-padre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Padre)</label><select id="esposa-padre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Padre)</label><select id="esposa-padre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Nombre de la Madre</label><input type="text" id="esposa-madre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Madre)</label><select id="esposa-madre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Madre)</label><select id="esposa-madre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Posee Visa</label><select id="esposa-visa" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Visa)</label><input type="date" id="esposa-visa-vigencia" class="form-input"></div>
                            <div><label class="form-label">Posee Residencia</label><select id="esposa-residencia" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Residencia)</label><input type="date" id="esposa-residencia-vigencia" class="form-input"></div>
                            <div><label class="form-label">Enfermedad</label><select id="esposa-enfermedad" class="form-input"><option>No</option><option>Sí</option></select></div>
                            <div><label class="form-label">Tipo de Enfermedad</label><input type="text" id="esposa-enfermedad-tipo" class="form-input"></div>
                            <div><label class="form-label">Desde Cuando</label><input type="date" id="esposa-enfermedad-desde" class="form-input"></div>
                            <div><label class="form-label">¿Está en Tratamiento?</label><select id="esposa-enfermedad-tratamiento" class="form-input"><option>Sí</option><option>No</option></select></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 3. Sección Ministerio -->
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>3. Ministerio</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="py-5">
                        <div class="grid grid-cols-form gap-6">
                            <div><label class="form-label">Fecha de Obrero Evangelista</label><input type="date" id="min-f-obrero" class="form-input"></div>
                            <div><label class="form-label">Fecha de Encargado Evangelista</label><input type="date" id="min-f-encargado" class="form-input"></div>
                            <div><label class="form-label">Fecha de Pastor Evangelista</label><input type="date" id="min-f-pastor" class="form-input"></div>
                            <div><label class="form-label">Fecha de Diácono Evangelista</label><input type="date" id="min-f-diacono" class="form-input"></div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-4">Funciones Ministeriales</h3>
                        <div class="grid grid-cols-form gap-6">
                            <div><label class="form-label">Ministerio o Comisión que colabora</label><input type="text" id="min-funcion-comision" class="form-input"></div>
                            <div><label class="form-label">Cargo dentro del Ministerio</label><input type="text" id="min-funcion-cargo" class="form-input"></div>
                            <div><label class="form-label">Desde Cuando</label><input type="date" id="min-funcion-desde" class="form-input"></div>
                            <div><label class="form-label">Cambio o Cese de Ministerio</label><input type="date" id="min-funcion-cese" class="form-input"></div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-4">Trabajo material realizado en la obra</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-compra-terreno" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-compra-terreno">Compra de terreno</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-cancelar-deuda" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-cancelar-deuda">Cancelar deuda</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-comenzar-pago" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-comenzar-pago">Comenzar a pagar</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-continuar-pago" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-continuar-pago">Continuar pagando</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-iniciar-construccion" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-iniciar-construccion">Iniciar construcción</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-finalizar-construccion" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-finalizar-construccion">Finalizar Construcción</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-elaborar-planos" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-elaborar-planos">Elaboración de planos</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-aprobar-planos" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-aprobar-planos">Aprobación de planos</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Sección Disciplina Ministerial -->
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>4. Disciplina Ministerial</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-form gap-6 py-5">
                        <div><label class="form-label">¿Ha sido puesto en disciplina alguna vez?</label><select id="disciplina-ha-sido" class="form-input"><option>No</option><option>Sí</option></select></div>
                        <div><label class="form-label">¿En qué fecha?</label><input type="date" id="disciplina-fecha" class="form-input"></div>
                        <div class="col-span-1 md:col-span-2"><label class="form-label">Tipo de Falta Cometida</label><input type="text" id="disciplina-falta" class="form-input"></div>
                        <div><label class="form-label">Pastor que Juzgó la Falta</label><input type="text" id="disciplina-pastor" class="form-input"></div>
                        <div><label class="form-label">¿Salió culpable o inocente?</label><select id="disciplina-culpable" class="form-input"><option>Culpable</option><option>Inocente</option></select></div>
                        <div><label class="form-label">¿Hubo testigos en el juicio?</label><select id="disciplina-testigos" class="form-input"><option>Sí</option><option>No</option></select></div>
                        <div><label class="form-label">¿Fue recogido o suspendido?</label><select id="disciplina-recogido" class="form-input"><option>Sí</option><option>No</option></select></div>
                        <div><label class="form-label">¿Por cuánto tiempo?</label><input type="text" id="disciplina-tiempo" class="form-input"></div>
                        <div><label class="form-label">¿Cambiado de Iglesia?</label><select id="disciplina-cambiado" class="form-input"><option>Sí</option><option>No</option></select></div>
                        <div><label class="form-label">¿Solo recibió amonestación?</label><select id="disciplina-amonestacion" class="form-input"><option>Sí</option><option>No</option></select></div>
                    </div>
                </div>
            </div>

            <!-- 5. Sección de Hijos (Dinámica) -->
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>5. Información de los Hijos</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                     <div class="py-5">
                        <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="cantidad-hijos" class="form-label">¿Cuántos Hijos Tiene?</label>
                                <input type="number" id="cantidad-hijos" class="form-input" min="0" value="0">
                            </div>
                            <div>
                                <label for="cantidad-varones" class="form-label">¿Cuántos Varones?</label>
                                <input type="number" id="cantidad-varones" class="form-input" min="0" value="0">
                            </div>
                            <div>
                                <label for="cantidad-mujeres" class="form-label">¿Cuántas Mujeres?</label>
                                <input type="number" id="cantidad-mujeres" class="form-input" min="0" value="0">
                            </div>
                            <button type="button" id="btn-generar-hijos" class="font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-blue-600 hover:bg-blue-700 focus:ring-blue-500">
                                <i class="fa-solid fa-plus mr-2"></i>Generar
                            </button>
                        </div>
                        <div id="hijos-container" class="space-y-6">
                            <!-- Las fichas de los hijos se generarán aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Sección de Récord Ministerial (Dinámica) -->
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>6. Récord Ministerial</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="py-5">
                        <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="cantidad-iglesias" class="form-label">¿En cuántas iglesias ha estado a cargo?</label>
                                <input type="number" id="cantidad-iglesias" class="form-input" min="0" value="0">
                            </div>
                            <button type="button" id="btn-generar-iglesias" class="font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-blue-600 hover:bg-blue-700 focus:ring-blue-500">
                                <i class="fa-solid fa-plus mr-2"></i>Generar
                            </button>
                        </div>
                        <div id="iglesias-container" class="space-y-6">
                            <!-- Las fichas de las iglesias se generarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- Botones de Acción -->
        <div id="action-buttons" class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
            <button id="btn-save-draft" class="w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-gray-600 hover:bg-gray-700 focus:ring-gray-500">
                <i class="fa-solid fa-save mr-2"></i>Guardar Borrador
            </button>
            <button id="btn-load-draft" class="w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-gray-500 hover:bg-gray-600 focus:ring-gray-400">
                <i class="fa-solid fa-folder-open mr-2"></i>Cargar Borrador
            </button>
            <button id="btn-exportar-excel" class="w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-green-600 hover:bg-green-700 focus:ring-green-500">
                <span id="excel-btn-text"><i class="fa-solid fa-download mr-2"></i>Descargar Ficha</span>
                <span id="excel-loader" class="hidden"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Procesando...</span>
            </button>
        </div>
        <div id="email-button-container" class="mt-8 text-center hidden">
             <p class="text-gray-700 mb-4">¡Ficha descargada! Ahora puedes enviarla por correo.</p>
             <a id="send-email-link" href="#" class="inline-block w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-blue-600 hover:bg-blue-700 focus:ring-blue-500">
                <i class="fa-solid fa-paper-plane mr-2"></i>Enviar por Correo
            </a>
        </div>
    </div>

    <script>
        // --- LÓGICA PARA EL ACORDEÓN ---
        document.addEventListener('DOMContentLoaded', function () {
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', function () {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });

            if(accordionHeaders.length > 0) {
                accordionHeaders[0].click();
            }

             // Comprobar si hay un borrador guardado
            if (localStorage.getItem('fichaMinisterialDraft')) {
                showToast('Se encontró un borrador guardado. Puede cargarlo con el botón "Cargar Borrador".', 'info');
            }
        });

        // --- Lógica para Notificaciones (Toast) ---
        function showToast(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            let borderColor = 'border-green-500';
            let icon = '<i class="fa-solid fa-check-circle text-green-500 mr-3"></i>';

            if (type === 'info') {
                borderColor = 'border-blue-500';
                icon = '<i class="fa-solid fa-info-circle text-blue-500 mr-3"></i>';
            } else if (type === 'error') {
                borderColor = 'border-red-500';
                icon = '<i class="fa-solid fa-exclamation-circle text-red-500 mr-3"></i>';
            }
            
            toast.className = `toast ${borderColor}`;
            toast.innerHTML = `${icon}<span>${message}</span>`;
            
            area.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // --- Lógica para previsualizar imágenes ---
        function previewImage(event, previewId, placeholderId) {
            const reader = new FileReader();
            reader.onload = function(){
                const preview = document.getElementById(previewId);
                preview.src = reader.result;
                preview.classList.remove('hidden');
                document.getElementById(placeholderId).classList.add('hidden');
            };
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        // --- Lógica para generar fichas de Hijos ---
        document.getElementById('btn-generar-hijos').addEventListener('click', function() {
            const cantidad = document.getElementById('cantidad-hijos').value;
            const container = document.getElementById('hijos-container');
            container.innerHTML = ''; 

            for (let i = 1; i <= cantidad; i++) {
                const hijoHTML = `
                    <div class="p-5 border border-gray-200 rounded-xl bg-white shadow-sm">
                        <h3 class="font-bold text-lg mb-4 text-indigo-700">Datos del Hijo/a ${i}</h3>
                        <div class="grid grid-cols-form gap-4">
                            <div><label class="form-label">Nombre Completo</label><input type="text" id="hijo-${i}-nombre" class="form-input"></div>
                            <div><label class="form-label">Fecha de Nacimiento</label><input type="date" id="hijo-${i}-f-nacimiento" class="form-input"></div>
                            <div><label class="form-label">Nivel Académico</label><input type="text" id="hijo-${i}-nivel-academico" class="form-input"></div>
                            <div><label class="form-label">Conocimiento de Oficios</label><input type="text" id="hijo-${i}-oficio" class="form-input"></div>
                            <div><label class="form-label">Enfermedad</label><select id="hijo-${i}-enfermedad" class="form-input"><option>No</option><option>Sí</option></select></div>
                            <div><label class="form-label">Tipo de Enfermedad</label><input type="text" id="hijo-${i}-enfermedad-tipo" class="form-input"></div>
                            <div><label class="form-label">Desde Cuando</label><input type="date" id="hijo-${i}-enfermedad-desde" class="form-input"></div>
                            <div><label class="form-label">¿Está en Tratamiento?</label><select id="hijo-${i}-enfermedad-tratamiento" class="form-input"><option>Sí</option><option>No</option></select></div>
                        </div>
                    </div>`;
                container.innerHTML += hijoHTML;
            }
            const content = container.closest('.accordion-content');
            if (content.style.maxHeight) {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });

        // --- Lógica para generar fichas de Iglesias ---
        document.getElementById('btn-generar-iglesias').addEventListener('click', function() {
            const cantidad = document.getElementById('cantidad-iglesias').value;
            const container = document.getElementById('iglesias-container');
            container.innerHTML = '';

            for (let i = 1; i <= cantidad; i++) {
                const iglesiaHTML = `
                    <div class="p-5 border border-gray-200 rounded-xl bg-white shadow-sm">
                        <h3 class="font-bold text-lg mb-4 text-indigo-700">Datos de la Iglesia ${i}</h3>
                        <div class="grid grid-cols-form gap-4">
                            <div><label class="form-label">Iglesia</label><input type="text" id="iglesia-${i}-nombre" class="form-input"></div>
                            <div><label class="form-label">Lugar</label><input type="text" id="iglesia-${i}-lugar" class="form-input"></div>
                            <div><label class="form-label">Fecha de Llegada</label><input type="date" id="iglesia-${i}-f-llegada" class="form-input"></div>
                            <div><label class="form-label">Fecha en que fue Cambiado</label><input type="date" id="iglesia-${i}-f-cambio" class="form-input"></div>
                            <div><label class="form-label">Miembros que Recibió</label><input type="number" id="iglesia-${i}-miembros-recibio" class="form-input" min="0"></div>
                            <div><label class="form-label">Bautismos</label><input type="number" id="iglesia-${i}-bautismos" class="form-input" min="0"></div>
                            <div><label class="form-label">Sellados</label><input type="number" id="iglesia-${i}-sellados" class="form-input" min="0"></div>
                            <div><label class="form-label">Restaurados</label><input type="number" id="iglesia-${i}-restaurados" class="form-input" min="0"></div>
                            <div><label class="form-label">Presentaciones de 40 días</label><input type="number" id="iglesia-${i}-presentaciones" class="form-input" min="0"></div>
                            <div><label class="form-label">Matrimonios</label><input type="number" id="iglesia-${i}-matrimonios" class="form-input" min="0"></div>
                            <div><label class="form-label">de Honra</label><input type="number" id="iglesia-${i}-honra" class="form-input" min="0"></div>
                            <div><label class="form-label">Miembros que dejó Registrados</label><input type="number" id="iglesia-${i}-miembros-dejo" class="form-input" min="0"></div>
                            <div><label class="form-label">en Casa</label><input type="number" id="iglesia-${i}-en-casa" class="form-input" min="0"></div>
                        </div>
                    </div>`;
                container.innerHTML += iglesiaHTML;
            }
            const content = container.closest('.accordion-content');
            if (content.style.maxHeight) {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
        
        // --- Lógica para Guardar Borrador ---
        document.getElementById('btn-save-draft').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('formulario-exportar'));
            const data = {};
            for (const [key, value] of formData.entries()) {
                const element = document.getElementById(key);
                if (element && element.type === 'checkbox') {
                    data[key] = element.checked;
                } else {
                    data[key] = value;
                }
            }
            
            // Guardar datos de hijos e iglesias
            data['hijos-data'] = [];
            const hijosCount = document.getElementById('cantidad-hijos').value;
            for(let i=1; i<=hijosCount; i++) {
                const hijo = {};
                document.querySelectorAll(`[id^="hijo-${i}-"]`).forEach(el => hijo[el.id] = el.value);
                data['hijos-data'].push(hijo);
            }

            data['iglesias-data'] = [];
            const iglesiasCount = document.getElementById('cantidad-iglesias').value;
            for(let i=1; i<=iglesiasCount; i++) {
                const iglesia = {};
                document.querySelectorAll(`[id^="iglesia-${i}-"]`).forEach(el => iglesia[el.id] = el.value);
                data['iglesias-data'].push(iglesia);
            }

            localStorage.setItem('fichaMinisterialDraft', JSON.stringify(data));
            showToast('Borrador guardado con éxito.', 'success');
        });

        // --- Lógica para Cargar Borrador ---
        document.getElementById('btn-load-draft').addEventListener('click', function() {
            const savedData = localStorage.getItem('fichaMinisterialDraft');
            if (savedData) {
                const data = JSON.parse(savedData);
                const form = document.getElementById('formulario-exportar');
                
                form.querySelectorAll('input, select').forEach(el => {
                    if (data[el.id]) {
                        if (el.type === 'checkbox') {
                            el.checked = data[el.id];
                        } else {
                            el.value = data[el.id];
                        }
                    }
                });

                // Cargar hijos
                if (data['hijos-data']) {
                    document.getElementById('cantidad-hijos').value = data['hijos-data'].length;
                    document.getElementById('btn-generar-hijos').click();
                    setTimeout(() => { // Esperar a que se creen los elementos
                        data['hijos-data'].forEach((hijoData, index) => {
                            for(const id in hijoData) {
                                document.getElementById(id).value = hijoData[id];
                            }
                        });
                    }, 100);
                }

                // Cargar iglesias
                if (data['iglesias-data']) {
                    document.getElementById('cantidad-iglesias').value = data['iglesias-data'].length;
                    document.getElementById('btn-generar-iglesias').click();
                     setTimeout(() => { // Esperar a que se creen los elementos
                        data['iglesias-data'].forEach((iglesiaData, index) => {
                             for(const id in iglesiaData) {
                                document.getElementById(id).value = iglesiaData[id];
                            }
                        });
                    }, 100);
                }

                showToast('Borrador cargado con éxito.', 'success');
            } else {
                showToast('No se encontró ningún borrador guardado.', 'error');
            }
        });

        // --- Lógica para Exportar a Excel y Enviar Correo ---
        document.getElementById('btn-exportar-excel').addEventListener('click', function(e) {
            e.preventDefault();
            const excelButton = this;
            const btnText = document.getElementById('excel-btn-text');
            const loader = document.getElementById('excel-loader');

            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            excelButton.disabled = true;

            setTimeout(() => {
                try {
                    const nombreMinistroInput = document.getElementById('ministro-nombre-completo');
                    const nombreMinistro = nombreMinistroInput.value.trim();
                    
                    if (!nombreMinistro) {
                         nombreMinistroInput.focus();
                         nombreMinistroInput.classList.add('border-red-500', 'ring-red-500');
                         nombreMinistroInput.placeholder = 'Este campo es obligatorio';
                         throw new Error("Nombre del ministro no ingresado.");
                    } else {
                         nombreMinistroInput.classList.remove('border-red-500', 'ring-red-500');
                    }

                    const fileName = `Ficha Ministerial ${nombreMinistro}.xlsx`;
                    const data = [['Sección', 'Campo', 'Valor']];
                    
                    // Lógica de recolección de datos (sin cambios)
                    // ...

                    const worksheet = XLSX.utils.aoa_to_sheet(data);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Ficha Ministerial");
                    XLSX.writeFile(workbook, fileName);

                    // Preparar el enlace de correo
                    const email = 'hmalldm95@gmail.com';
                    const subject = `Ficha Ministerial de ${nombreMinistro}`;
                    const body = `Hola,\n\nAdjunto mi ficha ministerial actualizada.\n\nSaludos,\n${nombreMinistro}`;
                    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    document.getElementById('send-email-link').href = mailtoLink;
                    document.getElementById('action-buttons').classList.add('hidden');
                    document.getElementById('email-button-container').classList.remove('hidden');


                } catch (error) {
                    showToast(error.message, 'error');
                    console.error("Error al generar el archivo:", error);
                } finally {
                    btnText.classList.remove('hidden');
                    loader.classList.add('hidden');
                    excelButton.disabled = false;
                }
            }, 500);
        });
    </script>
</body>
</html>
