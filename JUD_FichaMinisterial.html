<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Ministerial Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos personalizados y mejoras de diseño */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .accordion-header.active .chevron-icon {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
            padding: 0 1.25rem;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-600 mb-1;
        }
        .form-input {
            @apply block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-300;
        }
        .grid-cols-form {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .photo-placeholder {
            @apply w-36 h-44 bg-gray-100 rounded-lg flex flex-col items-center justify-center text-gray-500 border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-200 hover:border-indigo-400 transition-all duration-300;
        }
        .photo-placeholder i {
            @apply text-4xl mb-2 text-gray-400;
        }
        .photo-preview {
            @apply w-36 h-44 rounded-lg object-cover shadow-md;
        }
        /* Estilo para notificaciones */
        #notification-area {
            @apply fixed top-5 right-5 z-50;
        }
        .toast {
            @apply bg-white rounded-lg shadow-lg p-4 flex items-center border-l-4 mb-2;
            animation: fadeInOut 4s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="notification-area"></div>

    <div id="app-container" class="max-w-5xl mx-auto">
        <header class="text-center mb-8 p-6 bg-white rounded-lg shadow-md border border-gray-200/80">
            <h1 class="text-3xl font-bold text-blue-800 uppercase">Ficha Ministerial Digital</h1>
            <p class="text-md text-gray-600 mt-1">Información Ministerial - Edición 2025</p>
        </header>

        <form id="formulario-exportar">
            
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>1. Información del Ministro</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 py-5">
                        <div class="flex flex-col items-center lg:items-start">
                            <label class="form-label">Foto</label>
                            <div id="ministro-photo-placeholder" class="photo-placeholder" onclick="document.getElementById('ministro-photo-input').click()">
                                <i class="fa-solid fa-camera-retro"></i>
                                <span>Subir Foto</span>
                            </div>
                            <img id="ministro-photo-preview" class="photo-preview hidden" alt="Foto del Ministro"/>
                            <input type="file" id="ministro-photo-input" class="hidden" accept="image/*" onchange="previewImage(event, 'ministro-photo-preview', 'ministro-photo-placeholder')">
                        </div>
                        <div class="grid grid-cols-form gap-6 col-span-1 lg:col-span-3">
                            <div><label class="form-label">Nombre Completo (Según la cédula)</label><input type="text" id="ministro-nombre-completo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Nacimiento</label><input type="date" id="ministro-f-nacimiento" class="form-input"></div>
                            <div><label class="form-label">Ciudad</label><input type="text" id="ministro-ciudad" class="form-input"></div>
                            <div><label class="form-label">Departamento</label><input type="text" id="ministro-depto" class="form-input"></div>
                            <div><label class="form-label">País</label><input type="text" id="ministro-pais" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo</label><input type="date" id="ministro-f-bautismo" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Bautismo)</label><input type="text" id="ministro-iglesia-bautismo" class="form-input"></div>
                            <div><label class="form-label">Quien Bautizó</label><input type="text" id="ministro-quien-bautizo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo Espiritual</label><input type="date" id="ministro-f-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Espiritual)</label><input type="text" id="ministro-iglesia-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Quien Testificó</label><input type="text" id="ministro-quien-testifico" class="form-input"></div>
                            <div><label class="form-label">¿Se casó por la Iglesia?</label><select id="ministro-casado-iglesia" class="form-input"><option>Sí</option><option>No</option><option>Unión Libre</option></select></div>
                            <div><label class="form-label">Fecha de Matrimonio</label><input type="date" id="ministro-f-matrimonio" class="form-input"></div>
                            <div><label class="form-label">Quien los Casó</label><input type="text" id="ministro-quien-caso" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Matrimonio)</label><input type="text" id="ministro-iglesia-matrimonio" class="form-input"></div>
                            <div><label class="form-label">Fecha que Salió a la Obra</label><input type="date" id="ministro-f-salida-obra" class="form-input"></div>
                            <div><label class="form-label">Salió Soltero o Casado</label><select id="ministro-estado-salida" class="form-input"><option>Soltero</option><option>Casado</option></select></div>
                            <div><label class="form-label">Lugar donde salió</label><input type="text" id="ministro-lugar-salida" class="form-input"></div>
                            <div><label class="form-label">Ministro que lo recomendó</label><input type="text" id="ministro-quien-recomendo" class="form-input"></div>
                            <div><label class="form-label">Nivel Académico</label><input type="text" id="ministro-nivel-academico" class="form-input"></div>
                            <div><label class="form-label">Conocimiento de Oficio</label><input type="text" id="ministro-oficio" class="form-input"></div>
                            <div><label class="form-label">Nombre del Padre</label><input type="text" id="ministro-padre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Padre)</label><select id="ministro-padre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Padre)</label><select id="ministro-padre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Nombre de la Madre</label><input type="text" id="ministro-madre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Madre)</label><select id="ministro-madre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Madre)</label><select id="ministro-madre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Posee Visa</label><select id="ministro-visa" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Visa)</label><input type="date" id="ministro-visa-vigencia" class="form-input"></div>
                            <div><label class="form-label">Posee Residencia</label><select id="ministro-residencia" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Residencia)</label><input type="date" id="ministro-residencia-vigencia" class="form-input"></div>
                            <div><label class="form-label">Enfermedad</label><select id="ministro-enfermedad" class="form-input"><option>No</option><option>Sí</option></select></div>
                            <div><label class="form-label">Tipo de Enfermedad</label><input type="text" id="ministro-enfermedad-tipo" class="form-input"></div>
                            <div><label class="form-label">Desde Cuando</label><input type="date" id="ministro-enfermedad-desde" class="form-input"></div>
                            <div><label class="form-label">¿Está en Tratamiento?</label><select id="ministro-enfermedad-tratamiento" class="form-input"><option>Sí</option><option>No</option></select></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                 <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>2. Información de la Esposa</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 py-5">
                        <div class="flex flex-col items-center lg:items-start">
                            <label class="form-label">Foto</label>
                            <div id="esposa-photo-placeholder" class="photo-placeholder" onclick="document.getElementById('esposa-photo-input').click()">
                                <i class="fa-solid fa-camera-retro"></i>
                                <span>Subir Foto</span>
                            </div>
                            <img id="esposa-photo-preview" class="photo-preview hidden" alt="Foto de la Esposa"/>
                            <input type="file" id="esposa-photo-input" class="hidden" accept="image/*" onchange="previewImage(event, 'esposa-photo-preview', 'esposa-photo-placeholder')">
                        </div>
                        <div class="grid grid-cols-form gap-6 col-span-1 lg:col-span-3">
                           <div><label class="form-label">Nombre Completo (Según la cédula)</label><input type="text" id="esposa-nombre-completo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Nacimiento</label><input type="date" id="esposa-f-nacimiento" class="form-input"></div>
                            <div><label class="form-label">Ciudad</label><input type="text" id="esposa-ciudad" class="form-input"></div>
                            <div><label class="form-label">Departamento</label><input type="text" id="esposa-depto" class="form-input"></div>
                            <div><label class="form-label">País</label><input type="text" id="esposa-pais" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo</label><input type="date" id="esposa-f-bautismo" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Bautismo)</label><input type="text" id="esposa-iglesia-bautismo" class="form-input"></div>
                            <div><label class="form-label">Quien Bautizó</label><input type="text" id="esposa-quien-bautizo" class="form-input"></div>
                            <div><label class="form-label">Fecha de Bautismo Espiritual</label><input type="date" id="esposa-f-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Iglesia (Espiritual)</label><input type="text" id="esposa-iglesia-bautismo-es" class="form-input"></div>
                            <div><label class="form-label">Quien Testificó</label><input type="text" id="esposa-quien-testifico" class="form-input"></div>
                            <div><label class="form-label">Fecha que Salió a la Obra</label><input type="date" id="esposa-f-salida-obra" class="form-input"></div>
                            <div><label class="form-label">Salió Soltera o Casada</label><select id="esposa-estado-salida" class="form-input"><option>Soltera</option><option>Casada</option></select></div>
                            <div><label class="form-label">Lugar donde salió</label><input type="text" id="esposa-lugar-salida" class="form-input"></div>
                            <div><label class="form-label">Ministro que la recomendó</label><input type="text" id="esposa-quien-recomendo" class="form-input"></div>
                            <div><label class="form-label">Nivel Académico</label><input type="text" id="esposa-nivel-academico" class="form-input"></div>
                            <div><label class="form-label">Conocimiento de Oficio</label><input type="text" id="esposa-oficio" class="form-input"></div>
                            <div><label class="form-label">Nombre del Padre</label><input type="text" id="esposa-padre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Padre)</label><select id="esposa-padre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Padre)</label><select id="esposa-padre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Nombre de la Madre</label><input type="text" id="esposa-madre-nombre" class="form-input"></div>
                            <div><label class="form-label">¿Vive Aún? (Madre)</label><select id="esposa-madre-vive" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Es Hermano? (Madre)</label><select id="esposa-madre-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Posee Visa</label><select id="esposa-visa" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Visa)</label><input type="date" id="esposa-visa-vigencia" class="form-input"></div>
                            <div><label class="form-label">Posee Residencia</label><select id="esposa-residencia" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">Vigente (Residencia)</label><input type="date" id="esposa-residencia-vigencia" class="form-input"></div>
                            <div><label class="form-label">Enfermedad</label><select id="esposa-enfermedad" class="form-input"><option>No</option><option>Sí</option></select></div>
                            <div><label class="form-label">Tipo de Enfermedad</label><input type="text" id="esposa-enfermedad-tipo" class="form-input"></div>
                            <div><label class="form-label">Desde Cuando</label><input type="date" id="esposa-enfermedad-desde" class="form-input"></div>
                            <div><label class="form-label">¿Está en Tratamiento?</label><select id="esposa-enfermedad-tratamiento" class="form-input"><option>Sí</option><option>No</option></select></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>3. Ministerio</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="py-5">
                        <div class="grid grid-cols-form gap-6">
                            <div><label class="form-label">Fecha de Obrero Evangelista</label><input type="date" id="min-f-obrero" class="form-input"></div>
                            <div><label class="form-label">Fecha de Encargado Evangelista</label><input type="date" id="min-f-encargado" class="form-input"></div>
                            <div><label class="form-label">Fecha de Pastor Evangelista</label><input type="date" id="min-f-pastor" class="form-input"></div>
                            <div><label class="form-label">Fecha de Diácono Evangelista</label><input type="date" id="min-f-diacono" class="form-input"></div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-4">Funciones Ministeriales</h3>
                        <div class="grid grid-cols-form gap-6">
                            <div><label class="form-label">Ministerio o Comisión que colabora</label><input type="text" id="min-funcion-comision" class="form-input"></div>
                            <div><label class="form-label">Cargo dentro del Ministerio</label><input type="text" id="min-funcion-cargo" class="form-input"></div>
                            <div><label class="form-label">Desde Cuando</label><input type="date" id="min-funcion-desde" class="form-input"></div>
                            <div><label class="form-label">Cambio o Cese de Ministerio</label><input type="date" id="min-funcion-cese" class="form-input"></div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-4">Trabajo material realizado en la obra</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-compra-terreno" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-compra-terreno">Compra de terreno</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-cancelar-deuda" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-cancelar-deuda">Cancelar deuda</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-comenzar-pago" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-comenzar-pago">Comenzar a pagar</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-continuar-pago" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-continuar-pago">Continuar pagando</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-iniciar-construccion" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-iniciar-construccion">Iniciar construcción</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-finalizar-construccion" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-finalizar-construccion">Finalizar Construcción</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-elaborar-planos" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-elaborar-planos">Elaboración de planos</label></div>
                            <div class="flex items-center p-2 bg-gray-50 rounded-lg"><input id="obra-aprobar-planos" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3"><label for="obra-aprobar-planos">Aprobación de planos</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>4. Disciplina Ministerial</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="grid grid-cols-form gap-6 py-5">
                        <div><label class="form-label">¿Ha sido puesto en disciplina alguna vez?</label><select id="disciplina-ha-sido" class="form-input"><option>No</option><option>Sí</option></select></div>
                        <div><label class="form-label">¿En qué fecha?</label><input type="date" id="disciplina-fecha" class="form-input"></div>
                        <div class="col-span-1 md:col-span-2"><label class="form-label">Tipo de Falta Cometida</label><input type="text" id="disciplina-falta" class="form-input"></div>
                        <div><label class="form-label">Pastor que Juzgó la Falta</label><input type="text" id="disciplina-pastor" class="form-input"></div>
                        <div><label class="form-label">¿Salió culpable o inocente?</label><select id="disciplina-culpable" class="form-input"><option>Culpable</option><option>Inocente</option></select></div>
                        <div><label class="form-label">¿Hubo testigos en el juicio?</label><select id="disciplina-testigos" class="form-input"><option>Sí</option><option>No</option></select></div>
                        <div><label class="form-label">¿Fue recogido o suspendido?</label><select id="disciplina-recogido" class="form-input"><option>Sí</option><option>No</option></select></div>
                        <div><label class="form-label">¿Por cuánto tiempo?</label><input type="text" id="disciplina-tiempo" class="form-input"></div>
                        <div><label class="form-label">¿Cambiado de Iglesia?</label><select id="disciplina-cambiado" class="form-input"><option>Sí</option><option>No</option></select></div>
                        <div><label class="form-label">¿Solo recibió amonestación?</label><select id="disciplina-amonestacion" class="form-input"><option>Sí</option><option>No</option></select></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>5. Información de los Hijos</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                     <div class="py-5">
                        <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="cantidad-hijos" class="form-label">¿Cuántos Hijos Tiene?</label>
                                <input type="number" id="cantidad-hijos" class="form-input" min="0" value="0">
                            </div>
                            <div>
                                <label for="cantidad-varones" class="form-label">¿Cuántos Varones?</label>
                                <input type="number" id="cantidad-varones" class="form-input" min="0" value="0">
                            </div>
                            <div>
                                <label for="cantidad-mujeres" class="form-label">¿Cuántas Mujeres?</label>
                                <input type="number" id="cantidad-mujeres" class="form-input" min="0" value="0">
                            </div>
                            <button type="button" id="btn-generar-hijos" class="font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-blue-600 hover:bg-blue-700 focus:ring-blue-500">
                                <i class="fa-solid fa-plus mr-2"></i>Generar
                            </button>
                        </div>
                        <div id="hijos-container" class="space-y-6">
                            </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md mb-3 border border-gray-200/80 transition-all duration-300">
                <div class="accordion-header flex justify-between items-center w-full text-lg font-medium text-left text-gray-800 p-5 cursor-pointer hover:bg-gray-50">
                    <span>6. Récord Ministerial</span>
                    <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                </div>
                <div class="accordion-content">
                    <div class="py-5">
                        <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="cantidad-iglesias" class="form-label">¿En cuántas iglesias ha estado a cargo?</label>
                                <input type="number" id="cantidad-iglesias" class="form-input" min="0" value="0">
                            </div>
                            <button type="button" id="btn-generar-iglesias" class="font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-blue-600 hover:bg-blue-700 focus:ring-blue-500">
                                <i class="fa-solid fa-plus mr-2"></i>Generar
                            </button>
                        </div>
                        <div id="iglesias-container" class="space-y-6">
                            </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="action-buttons" class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="btn-save-draft" class="w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-gray-600 hover:bg-gray-700 focus:ring-gray-500">
                <i class="fa-solid fa-save mr-2"></i>Guardar Borrador
            </button>
            <button id="btn-load-draft" class="w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-gray-500 hover:bg-gray-600 focus:ring-gray-400">
                <i class="fa-solid fa-folder-open mr-2"></i>Cargar Borrador
            </button>
             <button id="btn-clear-draft" class="w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-red-600 hover:bg-red-700 focus:ring-red-500">
                <i class="fa-solid fa-trash-can mr-2"></i>Limpiar Borrador
            </button>
            <button id="btn-exportar-excel" class="w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-green-600 hover:bg-green-700 focus:ring-green-500">
                <span id="excel-btn-text"><i class="fa-solid fa-download mr-2"></i>Descargar Ficha</span>
                <span id="excel-loader" class="hidden"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Procesando...</span>
            </button>
        </div>
        <div id="email-button-container" class="mt-8 text-center hidden">
             <p class="text-gray-700 mb-4">¡Ficha descargada! Ahora puedes enviarla por correo.</p>
             <a id="send-email-link" href="#" class="inline-block w-full sm:w-auto font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 shadow-sm hover:shadow-lg bg-blue-600 hover:bg-blue-700 focus:ring-blue-500">
                <i class="fa-solid fa-paper-plane mr-2"></i>Enviar por Correo
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- LÓGICA PARA EL ACORDEÓN ---
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', function () {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        // Se agrega un pequeño extra para asegurar que el padding se vea bien
                        content.style.maxHeight = (content.scrollHeight + 20) + "px";
                    }
                });
            });

            // Abrir la primera sección por defecto
            if(accordionHeaders.length > 0) {
                accordionHeaders[0].click();
            }
            
            // --- EVENT LISTENERS PARA BOTONES ---
            document.getElementById('btn-generar-hijos').addEventListener('click', generarHijos);
            document.getElementById('btn-generar-iglesias').addEventListener('click', generarIglesias);
            
            // --- IMPLEMENTACIÓN DE GUARDAR Y CARGAR BORRADOR ---
            document.getElementById('btn-save-draft').addEventListener('click', saveDraft);
            document.getElementById('btn-load-draft').addEventListener('click', loadDraft);
            document.getElementById('btn-clear-draft').addEventListener('click', clearDraft);

            // Comprobar si hay un borrador guardado al cargar la página
            if (localStorage.getItem('fichaMinisterialDraft')) {
                showToast('Se encontró un borrador. Puede cargarlo con el botón "Cargar Borrador".', 'info');
            }
        });

        // --- Lógica para Notificaciones (Toast) ---
        function showToast(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            let borderColor = 'border-green-500';
            let icon = '<i class="fa-solid fa-check-circle text-green-500 mr-3 text-2xl"></i>';

            if (type === 'error') {
                borderColor = 'border-red-500';
                icon = '<i class="fa-solid fa-times-circle text-red-500 mr-3 text-2xl"></i>';
            } else if (type === 'info') {
                borderColor = 'border-blue-500';
                icon = '<i class="fa-solid fa-info-circle text-blue-500 mr-3 text-2xl"></i>';
            }

            toast.className = `toast ${borderColor}`;
            toast.innerHTML = `${icon} <p class="text-gray-700">${message}</p>`;
            area.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // --- Lógica para previsualizar imágenes ---
        function previewImage(event, previewId, placeholderId) {
            const reader = new FileReader();
            reader.onload = function(){
                const output = document.getElementById(previewId);
                output.src = reader.result;
                output.classList.remove('hidden');
                document.getElementById(placeholderId).classList.add('hidden');
            };
            if(event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }
        
        // --- SECCIÓN DE BORRADORES (NUEVO) ---
        const DRAFT_KEY = 'fichaMinisterialDraft';

        function saveDraft() {
            const formData = {};
            // Guardar todos los inputs, selects y textareas
            document.querySelectorAll('#formulario-exportar input, #formulario-exportar select').forEach(el => {
                if (el.type === 'checkbox') {
                    formData[el.id] = el.checked;
                } else if (el.type !== 'file') {
                    formData[el.id] = el.value;
                }
            });

            // Guardar imágenes
            document.querySelectorAll('img.photo-preview').forEach(img => {
                if (img.src && !img.src.endsWith('undefined')) { // Evitar guardar src vacíos
                    formData[img.id] = img.src;
                }
            });
            
            localStorage.setItem(DRAFT_KEY, JSON.stringify(formData));
            showToast('Borrador guardado exitosamente.', 'success');
        }

        function loadDraft() {
            const savedData = localStorage.getItem(DRAFT_KEY);
            if (!savedData) {
                showToast('No se encontró ningún borrador para cargar.', 'info');
                return;
            }

            const formData = JSON.parse(savedData);

            // Cargar datos en inputs, selects, etc.
            Object.keys(formData).forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'IMG') { // Cargar imágenes
                        if (formData[id].startsWith('data:image')) {
                            el.src = formData[id];
                            el.classList.remove('hidden');
                            const placeholderId = id.replace('-preview', '-placeholder');
                            const placeholder = document.getElementById(placeholderId);
                            if (placeholder) {
                                placeholder.classList.add('hidden');
                            }
                        }
                    } else if (el.type === 'checkbox') {
                        el.checked = formData[id];
                    } else {
                        el.value = formData[id];
                    }
                }
            });
            
            // Volver a generar las secciones dinámicas
            if (formData['cantidad-hijos'] > 0) {
                generarHijos(formData);
            }
            if (formData['cantidad-iglesias'] > 0) {
                generarIglesias(formData);
            }

            showToast('Borrador cargado correctamente.', 'success');
        }

        function clearDraft() {
            if (confirm('¿Estás seguro de que quieres eliminar el borrador guardado? Esta acción no se puede deshacer.')) {
                localStorage.removeItem(DRAFT_KEY);
                showToast('El borrador ha sido eliminado.', 'success');
                // Opcional: recargar la página para limpiar el formulario
                // window.location.reload();
            }
        }

        // --- SECCIONES DINÁMICAS (HIJOS E IGLESIAS) ---
        
        function generarHijos(dataToLoad = null) {
            const cantidad = document.getElementById('cantidad-hijos').value;
            const container = document.getElementById('hijos-container');
            container.innerHTML = ''; // Limpiar contenedor

            for (let i = 1; i <= cantidad; i++) {
                const hijoHTML = `
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50/50">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">Información del Hijo #${i}</h4>
                        <div class="grid grid-cols-form gap-4">
                            <div><label class="form-label">Nombre Completo</label><input type="text" id="hijo-${i}-nombre" class="form-input"></div>
                            <div><label class="form-label">Fecha de Nacimiento</label><input type="date" id="hijo-${i}-f-nacimiento" class="form-input"></div>
                            <div><label class="form-label">¿Es Hermano?</label><select id="hijo-${i}-hermano" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Está Bautizado?</label><select id="hijo-${i}-bautizado" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Está en la Obra?</label><select id="hijo-${i}-obra" class="form-input"><option>Sí</option><option>No</option></select></div>
                            <div><label class="form-label">¿Está Casado?</label><select id="hijo-${i}-casado" class="form-input"><option>Sí</option><option>No</option></select></div>
                        </div>
                    </div>
                `;
                container.innerHTML += hijoHTML;
            }
            
            // Si estamos cargando datos, los rellenamos
            if (dataToLoad) {
                 for (let i = 1; i <= cantidad; i++) {
                    document.getElementById(`hijo-${i}-nombre`).value = dataToLoad[`hijo-${i}-nombre`] || '';
                    document.getElementById(`hijo-${i}-f-nacimiento`).value = dataToLoad[`hijo-${i}-f-nacimiento`] || '';
                    document.getElementById(`hijo-${i}-hermano`).value = dataToLoad[`hijo-${i}-hermano`] || 'Sí';
                    document.getElementById(`hijo-${i}-bautizado`).value = dataToLoad[`hijo-${i}-bautizado`] || 'Sí';
                    document.getElementById(`hijo-${i}-obra`).value = dataToLoad[`hijo-${i}-obra`] || 'Sí';
                    document.getElementById(`hijo-${i}-casado`).value = dataToLoad[`hijo-${i}-casado`] || 'Sí';
                }
            }
        }

        function generarIglesias(dataToLoad = null) {
            const cantidad = document.getElementById('cantidad-iglesias').value;
            const container = document.getElementById('iglesias-container');
            container.innerHTML = '';

            for (let i = 1; i <= cantidad; i++) {
                const iglesiaHTML = `
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50/50">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">Récord de Iglesia #${i}</h4>
                        <div class="grid grid-cols-form gap-4">
                            <div><label class="form-label">País</label><input type="text" id="iglesia-${i}-pais" class="form-input"></div>
                            <div><label class="form-label">Ciudad</label><input type="text" id="iglesia-${i}-ciudad" class="form-input"></div>
                            <div><label class="form-label">Desde</label><input type="date" id="iglesia-${i}-desde" class="form-input"></div>
                            <div><label class="form-label">Hasta</label><input type="date" id="iglesia-${i}-hasta" class="form-input"></div>
                            <div class="col-span-1 md:col-span-2"><label class="form-label">Comentarios</label><input type="text" id="iglesia-${i}-comentarios" class="form-input"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += iglesiaHTML;
            }

            if (dataToLoad) {
                for (let i = 1; i <= cantidad; i++) {
                    document.getElementById(`iglesia-${i}-pais`).value = dataToLoad[`iglesia-${i}-pais`] || '';
                    document.getElementById(`iglesia-${i}-ciudad`).value = dataToLoad[`iglesia-${i}-ciudad`] || '';
                    document.getElementById(`iglesia-${i}-desde`).value = dataToLoad[`iglesia-${i}-desde`] || '';
                    document.getElementById(`iglesia-${i}-hasta`).value = dataToLoad[`iglesia-${i}-hasta`] || '';
                    document.getElementById(`iglesia-${i}-comentarios`).value = dataToLoad[`iglesia-${i}-comentarios`] || '';
                }
            }
        }
    </script>

</body>
</html>